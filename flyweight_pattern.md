# 享元模式


迷雾散尽，显现出一个古老庄严的森林。无数古老的铁杉，在头顶形成了一个绿色的教堂。阳光被树叶分割成分割成金色的水平，在巨大的树干间，远处的森林逐渐模糊。

这是一个游戏开发者想象中的场景，这样的场景经常使用一个设计模式来实现：享元模式。

## 森林
我可以用几个词来形容一个巨大的森林，但是在一个实时游戏中实现就是另一回事了。当你看到屏幕上数不清的树木时，一个图形程序员看到的是每1/60秒要向GPU传送数百万个多边形进行绘制。

我们讨论的这成千上万的树，每一颗树木又有成千上万个多边形构成。就算有足够的内存来保存这个森林，为了渲染它们，从CPU向GPU传送这些数据也是会过载的。

每个树都有一些固定的特征
- 一个多边形网格来描述树枝、树干和树叶。
- 树皮和树叶的纹理。
- 它在森林中的位置和朝向
- 一些参数比如大小和色彩等，使得每棵树看起来都不一样

如果想用代码来描述这些特征，看起来如下所示：
```cpp
class Tree
{
private:
  Mesh mesh_;
  Texture bark_;
  Texture leaves_;
  Vector position_;
  double height_;
  double thickness_;
  Color barkTint_;
  Color leafTint_;
};
```
这是相当多的数据量，尤其是网格和纹理数据十分大。一个巨大的森林包含如此多的数据，在一帧内传给GPU实在是太多了。幸运的是，有一个历史悠久的方法来解决它。

关键问题在于，即使森林中有成千上万的树，这些树看起来也是相似的。它们可能使用了相同的网格和纹理，这意味着这些树木实例中很多字段可以使用相同的对象。

![](img/flyweight-trees.png)

我们可以将类分为两部分。首先，我们将所有树共享的数据拉出来放到一个单独的类里。
```cpp
class TreeModel
{
private:
  Mesh mesh_;
  Texture bark_;
  Texture leaves_;
};
```

整个游戏只需要一个TreeModel实例，没有理由在内存里放数千个相同的网格和纹理。接下来，每个树的实例都会有一个到共享的TreeModel的引用。Tree类中余下的都是实例特有的字段。

```cpp
class Tree
{
private:
  TreeModel* model_;

  Vector position_;
  double height_;
  double thickness_;
  Color barkTint_;
  Color leafTint_;
};
```

这个结构可以表现为下图：
![](img/flyweight-tree-model.png)

这样做对在内存中存储十分有用，但对渲染却依然没有什么用处。将森林渲染到屏幕上之前，数据要先传送到GPU。我们需要以显卡可以理解的方式来共享数据。

## 一千个实例

为了减少传给GPU的数据，我们希望将共享的数据TreeModel只发送一次，然后我们再发送实例特有的数据，包括位置、颜色、缩放等。然后，我们告诉GPU，“使用同一个模型渲染这些实例。”

幸运的是，现代的显卡API都支持这样的实现，实现的细节已经超出了本书范围，但是Direct3D和OpenGL都可以做到实例渲染(Instanced Rendering)。

在这两者的API中，你需要提供两条数据流，第一条是需要渲染时使用多次的共享数据，在我们的实例中就是纹理和多边形网格。第二条就是实例的列表以及参数。然后调用一次渲染，一个森林就绘制好了。

## 享元模式

现在我们已经看了一个具体的例子，接下来让我们再介绍享元设计模式。享元模式，就像它的名字一样，如果一个对象比较通用并且数量众多，那么久可以让它变成共享的。

在实例渲染中，渲染每课树更多的消耗是把数据从CPU传送到GPU的时间，而不是内存，但是本质是相同的。

该设计模式通过将对象的数据分成两部分来解决这个问题，第一部分数据对于一个对象的所有实例来说都是相同的，可以在实例之间共享。GOF称此为固有状态，但是我更愿意称他们为“上下文无关的”。在该例中，指的就是树的网格和纹理。

数据的剩余部分就是非固化数据，在每一个实例中都不相同的。在该例中，指的就是树的位置、缩放和颜色。就像前面的代码一样，该模式通过共享同一份固有数据来节省内存。

但就目前而言，这种做法更像是资源共享，难以称的上是一种设计模式。这某种程度上是因为这个样例中我们对共享数据定义了清晰的身份：TreeModel。

我发现当我们没有为共享对象定义身份时，这个模式就不那么明显了。这时，感觉就像一个对象魔术般的分布了在不同的地方，让我给你展示灵位一个例子。

## 扎根的地方

